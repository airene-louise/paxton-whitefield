{% comment %}

  When you render a product card you must send a product with the render.
  Example:
    {% render 'product-card', product: collections['all'].products.first %}

  Below is a list of variables that alter things like default text,
  or show and hide different pieces of information. You can override
  any of the default settings by sending your own value with the render.
  Examples:
    {% render 'product-card', product: collections['all'].products.first, button_text: "Add to basket" %}
    {% render 'product-card', product: collections['all'].products.first, quickshop_enabled: false %}
    {% render 'product-card', product: collections['all'].products.first, show_vendor: true %}

{% endcomment %}

{% liquid

  comment # Card classes #
  endcomment
  assign additional_classes = additional_classes | default: ''

  comment # Card button #
  endcomment
  assign show_button = show_button | default: true , allow_false: true
  assign button_text = button_text | default: 'product_card.view_product' | t 
  assign quickshop_enabled = quickshop_enabled | default: true , allow_false: true
  assign quickshop_button_text = quickshop_button_text | default: 'product_card.quick_shop' | t 

  comment # Displays a badge when product has a compare_at_price #
  endcomment
  assign show_sale_tag = show_sale_tag | default: true , allow_false: true
  assign sale_tag_text = sale_tag_text | default: 'product_card.sale' | t 

  comment # Displays a badge when product was created less than 30 days ago #
  endcomment
  assign show_new_tag = show_new_tag | default: true , allow_false: true
  assign new_tag_text = new_tag_text | default: 'product_card.new' | t 

  comment # Sets image aspect ratio, valid values are "square", "portrait", or "landscape" #
  endcomment
  assign image_aspect_ratio = "portrait"

  comment # Toggles on/off some product info in the card #
  endcomment
  assign show_title = show_title | default: true , allow_false: true
  assign show_vendor = show_vendor | default: true , allow_false: true
  assign show_product_type = show_product_type | default: false
  assign show_price = show_price | default: true , allow_false: true
  assign show_compare_at_price = show_compare_at_price | default: true , allow_false: true

  comment # Some date logic to determine new products if new tag is enabled #
  endcomment
  if show_new_tag
    assign created_date = product.created_at | date: "%s"
    assign current_date = 'now' | date: "%s"
    assign seconds_difference = current_date | minus: created_date
    assign days_difference = seconds_difference | divided_by: 3600 | divided_by: 24
    if days_difference < 30
      assign is_new_product = true
    else
      assign is_new_product = false
    endif 
  endif

  assign show_only_pick_up = product.available
  for variant in product.variants
    for store in variant.store_availabilities
      if store.location.name == 'Bourton'
        if store.available
          assign show_only_pick_up = false
        endif
      endif
    endfor
  endfor
%}

{% if product != blank %}
  <div class="product-card {{ additional_classes }}">

    {% comment %} Image container, also contains any enabled badges {% endcomment %}
    <div class="product-card__image-container product-card__image-container--{{ image_aspect_ratio }}">

      <div class="product-card__rollover-images">
        {% comment %} Alternate Image - shown on hover {% endcomment %}
        {% if product.images.size > 1 %}
          <div class="product-card__alternate-image">
            <a href="{{ product.url }}">
              {{ product.images[1]
                | image_url: width: product.images[1].width
                | image_tag:
                  alt: product.images[1].alt,
                  width: 255,
                  height: 350,
                  class: 'product-card__image',
                  loading: 'lazy',
                  sizes: '(min-width: 750px) 25vw, 100vw'
              }}
            </a>
          </div>
        {% endif %}

        {% comment %} Image {% endcomment %}
          <div class="product-card__original-image">
            <a href="{{ product.url }}">
              {% if product.featured_image != blank %}
                {{ product.featured_image
                  | image_url: width: product.featured_image.width
                  | image_tag:
                    alt: product.featured_image.alt,
                    width: 255,
                    height: 350,
                    class: 'product-card__image',
                    loading: 'lazy',
                    sizes: '(min-width: 750px) 25vw, 100vw'
                }}
              {% else %}
                {{ 'image' | placeholder_svg_tag: 'product-card__image' }}
              {% endif %}
            </a>
          </div>
        
          {% unless product.type == 'Gift Card' %}
        <div class="product-card__buttons">
          <a href="{{ product.url }}" class="product-card__view-button">View</a>
           
          {% if product.available or show_only_pick_up == false %}
            {% if product.has_only_default_variant %}
              {% if product.available %}
                <button class="product-card__buy-button" onclick="Cart.addItem({{ product.selected_or_first_available_variant.id }}, 1)">ADD TO CART</button>
              {% else %}
                <button class="product-card__buy-button" disabled>SOLD OUT</button>
              {% endif %}
            {% else %}
              {% if product.available %}
                <button class="product-card__buy-button js-product-card-variant-selector" data-product-id="{{ product.id }}">ADD TO CART</button>
              {% else %}
                <button class="product-card__buy-button" disabled>SOLD OUT</button>
              {% endif %}
              <div class="product-card__variant-selector" id="variant-selector-{{ product.id }}" style="display: none;">
                <div class="product-card__variant-selector__inner">
                  <div class="product-card__variant-selector__header">
                    <h4>Select a variant</h4>
                    <button class="product-card__variant-selector__close" data-product-id="{{ product.id }}">&times;</button>
                  </div>
                  <div class="product-card__variant-selector__options">
                    {% for variant in product.variants %}
                      {% if variant.available %}
                        <button class="product-card__variant-selector__variant-option" onclick="Cart.addItem({{ variant.id }}, 1); document.getElementById('variant-selector-{{ product.id }}').style.display = 'none';">
                          {{ variant.title }} - {{ variant.price | money }}
                        </button>
                      {% else %}
                        <button class="product-card__variant-option product-card__variant-option--sold-out" disabled>
                          {{ variant.title }} - Sold Out
                        </button>
                      {% endif %}
                    {% endfor %}
                  </div>
                </div>
              </div>
              <script>
                document.addEventListener('DOMContentLoaded', function() {
                  const variantSelectors = document.querySelectorAll('.js-product-card-variant-selector');
                  const closeButtons = document.querySelectorAll('.product-card__variant-selector-close');
                  
                  variantSelectors.forEach(button => {
                    button.addEventListener('click', function(e) {
                      e.preventDefault();
                      const productId = this.getAttribute('data-product-id');
                      const selector = document.getElementById('variant-selector-' + productId);
                      selector.style.display = 'block';
                    });
                  });
                  
                  closeButtons.forEach(button => {
                    button.addEventListener('click', function(e) {
                      e.preventDefault();
                      const productId = this.getAttribute('data-product-id');
                      const selector = document.getElementById('variant-selector-' + productId);
                      selector.style.display = 'none';
                    });
                  });
                });
              </script>
            {% endif %}
          {% else %}
            <a href="{{ product.url }}" class="product-card__notify-button">
              {% if show_only_pick_up %}
                Notify Me
              {% else %}
                Notify Me
              {% endif %}
              </a>
            {% endif %}
          </div>
        {% endunless %}
      </div>

      {% comment %} Badges {% endcomment %}
      <div class="product-card__badges">

        {% comment %} Sale tag {% endcomment %}
        {% if show_sale_tag and product.compare_at_price and product.compare_at_price > product.price %}
          <div class="product-card__tag">
          {{- sale_tag_text -}}
          </div>
        {% endif %}

        {% if show_sale_tag and product.compare_at_price and product.compare_at_price > product.price %}
          <div class="product-card__tag">
          {{- sale_tag_text -}}
          </div>
        {% endif %}


        {% if product.available == false or product.tags contains 'sold-out' %}
          <div class="product-card__tag">
            Sold Out
          </div>
        {% endif %}

        {% assign metafield_string = product.metafields.custom.product_tags | remove: '[' | remove: ']' %}
        {% assign labels = metafield_string | split: ',' %}  <!-- Splitting the array -->

        {% for label in labels %}
          {% unless label contains 'Sold Out' %}
            <div class="product-card__tag">
              {{ label | strip | remove: '"' }} <!-- Removing extra quotes and whitespace -->
            </div>
          {% endunless %}
        {% endfor %}
      </div>

    </div>

    {% comment %} Product info {% endcomment %}
    <div class="product-card__info">

      {% comment %} Title {% endcomment %}
      {% if show_title %}
        <h3 class="product-card__title">
          <a href="{{ product.url }}">{{ product.title }}</a>
        </h3>
      {% endif %}

      {% comment %} Price {% endcomment %}
      {% if show_price %}
        <div class="product-card__price-container">

          {% comment %} Default price {% endcomment %}
          <span class="product-card__price">
            {% if product.price_varies %}From {% endif %}{{ product.price | money }}
          </span>

          {% comment %} Compare at price {% endcomment %}
          {% if show_compare_at_price and product.compare_at_price %}
            <span class="product-card__compare-at-price">{{ product.compare_at_price | money }}</span>
          {% endif %}

          {% if product.metafields.custom.unit_size != blank %}
            <span class="product-card__unit-size">{{ product.metafields.custom.unit_size }}</span>
          {% endif %}

        </div>
      {% endif %}

      <div
        class="yotpo-widget-instance product-card__reviews"
        data-yotpo-instance-id="645215"
        data-yotpo-product-id="{{ product.id }}"
        data-yotpo-cart-product-id="{{ item.product.id }}"
        data-yotpo-section-id="{{ template.name }}"
      ></div>
    </div>

    <div class="product-card__description">
      {% if product.metafields.custom.short_description != blank %}
        <p>{{ product.metafields.custom.short_description | truncate: 100 }}</p>
      {% else %}
        <p>{{ product.description | strip_html | truncate: 100 }}</p>
      {% endif %}
    </div>

    {% if template.name == 'product' %}
      <span class="product-card__buy-button" onclick="Cart.addItem({{ product.selected_or_first_available_variant.id }}, 1)">Buy Now</span>
    {% else %}
      <a class="product-card__buy-button hidden" href="{{ product.url }}">Buy Now</a>
    {% endif %}

  </div> <!-- .product-card -->

{% else %}
  <div class="product-card {{ additional_classes }}"><!-- Attempting to render a product card, but no product provided. --></div>
{% endif %}

<style>


.cart-page__recos__products .product-card__buttons {
  display: none !important;
} 

.cart-page__recos__products .product-card__view-button {
  display: none !important;
} 
</style>