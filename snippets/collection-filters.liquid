<div class="collection__filters">
  <div class="collection__filters__inner">

    {% comment %} This header is only shown on mobile {% endcomment %}
    <div class="collection__filters__header">
      <h3><span>{% render 'icons', icon: 'filter' %}</span>{{ "collection.filters.title" | t }} & Sort</h3>
      <span class="collection__filters__close" onclick="toggleFilters()">
        <span>Close</span>
        {% render 'icons', icon: 'close' %}
      </span>
    </div>

    <form class="collection__filters__form" onsubmit="Filter.handleSubmit(event)">

      <div class="collection__filters__filter-groups">
        <div class="filter-group">
          <div class="filter-group__container">
            <h4 class="filter-group__title">Sort By<span>{% render 'icons', icon: 'plus' %}</span></h4>
              <div class="filter-group__dropdown">
                <ul class="filter-group__list sort-by">  
                {% for option in collection.sort_options %}
                  <li class="filter-group__item">
                    <input type="checkbox" name="sort_by" value="{{ option.value }}" id="sort-by" onchange="Filter.handleSortBy(event)">
                    <label for="sort_by">{{ option.name }} </label>
                  </li>
                {% endfor %}
              
                </ul>
              </div>
            </div>
          </div>
        
        </div>
        {% liquid        
          for filter in collection.filters
            render "filter-group", filter: filter
          endfor
        %}
      </div>
      
      <button
        class="collection__filters__submit-button"
        type="submit"
        hidden
      >
        {{ "collection.filters.view" | t }}
      </button>
    </form>

    {% comment %} This header is only shown on mobile {% endcomment %}
    <div class="collection__filters__footer">
      <button id="viewButton" class="collection__filters__view" onclick="toggleFilters()">{{ "collection.filters.view" | t }}</button>
      <button class="collection__filters__clear-all" onclick="Filter.clearAllFilters()">{{ "collection.filters.clear_all" | t }}</button>
    </div>

  </div>

</div>

<script>
  // Set up toggle filters button to show modal on mobile
  function toggleFilters() {
    const filters = document.querySelector('.collection__side-bar');
    const overlay = document.querySelector('.collection__filters__overlay');
    filters.classList.toggle('is-open');
    overlay.classList.toggle('is-open');
    document.body.classList.toggle('no-scroll');
  };
  const sortOptions = document.querySelectorAll('.sort-by input');
  sortOptions.forEach(option => {
    option.addEventListener('change', event => {
      sortOptions.forEach(option => {
        option.checked = false;
      });
      option.checked = true;
    });
  });
  document.addEventListener('filtersCleared', () => {
    // Remove checkboxes
    const filtersForm = document.querySelector('.collection__filters__form');
    filtersForm.reset();

    // form.reset() do not remove the "checked" attribute, so this piece of code
    // so this piece of code is required when you clear all filters after
    // landing to a collection with the filters applied in the URL
    const checkedInputs = filtersForm.querySelectorAll('input[type="checkbox"][checked]');
    checkedInputs.forEach(input => input.removeAttribute('checked'));
  });

  const url = window.location.href;
  const urlParams = new URLSearchParams(url.split('?')[1]);

  const hasGte = urlParams.has('filter.v.price.gte');
  const hasLte = urlParams.has('filter.v.price.lte');

  if (hasGte) {
      const gtePrice = urlParams.get('filter.v.price.gte');
      document.querySelector('input.price-from').value = gtePrice;
  } 
  if(hasLte) {
      const ltePrice = urlParams.get('filter.v.price.lte');
      document.querySelector('input.price-to').value = ltePrice;
  }

  // Set up filter dropdowns for desktop
  const filterToggleButton = document.querySelectorAll('.filter-group__title');
  filterToggleButton.forEach(button => {
    button.addEventListener('click', event => {
      const trigger = event.currentTarget;
      const filterGroup = trigger.closest('.filter-group');
      if (filterGroup.classList.contains('is-open')) {
        filterGroup.classList.remove('is-open');
        document.removeEventListener('click', handleClickOutside, true);
        filterGroup.querySelector('svg path:first-child').style.display = 'block';
      } else {
        filterGroup.classList.add('is-open');
        filterGroup.querySelector('svg path:first-child').style.display = 'none';
        if (window.innerWidth > 767) {
          document.addEventListener('click', handleClickOutside, true);
        }
      }
    })
  });


  // Set up filter dropdowns closing when clicking outside
  function handleClickOutside() {
    const clickedElement = event.target;
    const openedFilterDropdown = document.querySelector('.filter-group.is-open');
    if (openedFilterDropdown !== clickedElement && !openedFilterDropdown.contains(clickedElement)) {
      openedFilterDropdown.classList.remove('is-open');
      document.removeEventListener('click', handleClickOutside, true);
    }
  };
</script>